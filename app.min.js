import intlTelInput from "intl-tel-input";
import { ru } from "intl-tel-input/i18n";

document.addEventListener("DOMContentLoaded", () => {
  initializeAnchorHandler();
  initializeDatePicker();
  initializeTransactionList();
  initialPhoneMask()
  initialCustomAccordion()
});

function initialPhoneMask () {
let iti;

if (iti) return

const phoneInputs = document.querySelectorAll(".phone-input");

phoneInputs.forEach((phoneInput) => {
  iti = intlTelInput(phoneInput, {
    initialCountry: "kz",
    strictMode: true,
    loadUtils: () => import("intl-tel-input/utils"),
    // geoIpLookup: function (callback) {
    //   fetch("https://ipapi.co/json/")
    //     .then((res) => res.json())
    //     .then((data) => {
    //       callback(data.country_code);
    //     })
    //     .catch(() => callback("KZ"));
    // },
    allowDropdown: true,
    autoHideDialCode: false,
    dropdownContainer: document.body,
    preferredCountries: ["kz", "ru"],
    i18n: ru,
  });
  window.iti = iti;
  let masked;

  function updateMask() {
    const selectedCountry = iti.getSelectedCountryData();

    const countryMask = getMaskForCountry(selectedCountry.iso2);
    if (countryMask) {
      if (masked) {
        masked.destroy();
      }
      masked = IMask(phoneInput, {
        mask: countryMask,
        lazy: false,
      });
    }
  }

  function getMaskForCountry(countryCode) {
    const countryMasks = {
      kz: "+{7} (000) 000-00-00",
      ru: "+{7} (000) 000-00-00",
      us: "+{1} (000) 000-0000",
      gb: "+{44} 0000 000 000",
      fr: "+{33} 0 00 00 00 00",
      de: "+{49} 000 000000",
    };
    return countryMasks[countryCode] || "+{000} 000-000-0000";
  }

   phoneInput.addEventListener("countrychange", () => {
      updateMask();
      phoneInput.value = iti.getNumber();
    });
    // phoneInput.addEventListener("input", function () {
    //   console.log("Форматированный номер:", iti.getNumber());
    //   console.log("Валидность номера:", iti.isValidNumber());
    // });

    updateMask();
});

}

function initializeAnchorHandler() {
  function handleAnchorLink() {
    const hash = window.location.hash;
    if (!hash || (hash !== "rules" && hash !== "policy")) return;

    const targetAccordionItem = document.querySelector(hash);
    console.log(targetAccordionItem);
    if (targetAccordionItem) {
      const button = targetAccordionItem.querySelector(".accordion-button");
      const collapseElement = targetAccordionItem.querySelector(".accordion-collapse");

      if (button && collapseElement) {
        document.querySelectorAll(".accordion-collapse").forEach((collapse) => {
          const bsCollapse = new bootstrap.Collapse(collapse, { toggle: false });
          bsCollapse.hide();
        });

        const bsCollapse = new bootstrap.Collapse(collapseElement, { toggle: false });
        bsCollapse.show();

        collapseElement.addEventListener(
          "shown.bs.collapse",
          () => {
            const offsetTop = button.getBoundingClientRect().top + window.scrollY - 100;
            window.scrollTo({
              top: offsetTop,
              behavior: "smooth",
            });
          },
          { once: true }
        );
      }
    }
  }

  handleAnchorLink();
  window.addEventListener("hashchange", handleAnchorLink);
}

function initializeDatePicker() {
  const datepickerElement = document.getElementById("datepicker");

  if (datepickerElement) {
    const picker = flatpickr(datepickerElement, {
      dateFormat: "d.m.Y",
      locale: "ru",
      allowInput: true,
      onChange: function (selectedDates, dateStr) {
        console.log("Выбранная дата:", dateStr);
      },
    });

    document.querySelectorAll(".datepicker-show").forEach((button) => {
      button.addEventListener("click", () => {
        picker.open();
      });
    });
  }
}

function initializeTransactionList() {
  const transactionList = document.querySelector(".transaction-list");

  if (transactionList) {
    transactionList.addEventListener("click", (event) => {
      const button = event.target.closest(".btn-details");
      if (button) {
        const transactionItem = button.closest(".transaction-item");
        const details = transactionItem.querySelector(".transaction-item-details");

        if (details) {
          details.classList.toggle("expanded");

          const spanElements = button.querySelectorAll("span");
          if (details.classList.contains("expanded")) {
            spanElements[0].style.display = "none";
            spanElements[1].style.display = "inline";
          } else {
            spanElements[0].style.display = "inline";
            spanElements[1].style.display = "none";
          }
        }
      }
    });
  }
}

function initialCustomAccordion () {
     const accordions = document.querySelectorAll(".custom-accordion");

    if (!accordions.length) return;

    accordions.forEach((accordion) => {
        const header = accordion.querySelector(".custom-accordion-header");
        const content = accordion.querySelector(".custom-accordion-content");

        if (!header || !content) return;

        header.addEventListener("click", function () {
            const isActive = accordion.classList.contains("active");

            accordions.forEach((acc) => acc.classList.remove("active"));

            if (!isActive) {
                accordion.classList.add("active");
            }
        });
    });
}
